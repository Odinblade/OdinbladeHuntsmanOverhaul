Version 1
SubGoalCombiner SGC_AND
INITSECTION
//REGION EA DamageTypes
DB_OBHUN_Elemental_Arrowhead("ARROWHEAD_BLOOD", "Physical");
DB_OBHUN_Elemental_Arrowhead("ARROWHEAD_ELECTRIC", "Air");
DB_OBHUN_Elemental_Arrowhead("ARROWHEAD_FIRE", "Fire");
DB_OBHUN_Elemental_Arrowhead("ARROWHEAD_OIL", "Earth");
DB_OBHUN_Elemental_Arrowhead("ARROWHEAD_POISON", "Poison");
DB_OBHUN_Elemental_Arrowhead("ARROWHEAD_WATER", "Water");
//END_REGION

//REGION EA HitTypes
DB_OBHUN_EA_HitType(2);
DB_OBHUN_EA_HitType(3);
//END_REGION

//REGION DamageTypes
DB_OBHUN_DamageType("Physical");
DB_OBHUN_DamageType("Poison");
DB_OBHUN_DamageType("Fire");
DB_OBHUN_DamageType("Water");
DB_OBHUN_DamageType("Air");
DB_OBHUN_DamageType("Piercing");
DB_OBHUN_DamageType("Earth");
DB_OBHUN_DamageType("Chaos");
//END_REGION

//REGION Excluded EA Skills
//Crafted arrow skills
DB_OBHUN_EA_ExcludedSkill("Projectile_BleedingArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_BlessedWaterArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_CharmingArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_CursedFireArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_DebuffAllArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_ExplosionArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_FireArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_FreezingArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_KnockedOutArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_PoisonArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_PoisonedCloudArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_SilverArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_SlowDownArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_SmokescreenArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_StaticCloudArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_SteamCloudArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_StunningArrow", 1000);
DB_OBHUN_EA_ExcludedSkill("Projectile_WaterArrow", 1000);

//Skills which have unique damage calculation
// DB_OBHUN_EA_ExcludedSkill("Projectile_ArrowSpray", 3450);
DB_OBHUN_EA_ExcludedSkill("Projectile_OdinHUN_PowerShot", 1000);
//END_REGION

//REGION Crafted Arrows & Grenades
//Crafted Arrow skills
DB_OBHUN_CraftedArrowsSkill("Projectile_BleedingArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_BleedingArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_BlessedWaterArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_BlessedWaterArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_CharmingArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_CharmingArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_CursedFireArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_CursedFireArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_DebuffAllArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_DebuffAllArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_ExplosionArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_ExplosionArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_FireArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_FireArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_FreezingArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_FreezingArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_KnockedOutArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_KnockedOutArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_PoisonArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_PoisonArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_PoisonedCloudArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_PoisonedCloudArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_SilverArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_SilverArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_SlowDownArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_SlowDownArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_SmokescreenArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_SmokescreenArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_StaticCloudArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_StaticCloudArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_SteamCloudArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_SteamCloudArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_StunningArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_StunningArrow_-1");
DB_OBHUN_CraftedArrowsSkill("Projectile_WaterArrow");
DB_OBHUN_CraftedArrowsSkill("Projectile_WaterArrow_-1");

//Grenade skills
DB_OBHUN_GrenadeSkill("Projectile_Grenade_ArmorPiercing", "e057dc4a-3921-4740-a5ac-a4ca6a7a32f7");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_ArmorPiercing_-1", "e057dc4a-3921-4740-a5ac-a4ca6a7a32f7");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_BlessedIce", "4b70b9dc-ac99-415c-bfc8-15cd6dc9aa7d");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_BlessedIce_-1", "4b70b9dc-ac99-415c-bfc8-15cd6dc9aa7d");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_BlessedOilFlask", "d44fa069-7708-4c0f-a924-f66a75802113");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_BlessedOilFlask_-1", "d44fa069-7708-4c0f-a924-f66a75802113");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_ChemicalWarfare", "bdff5d65-29ef-425c-9096-a119e4de228f");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_ChemicalWarfare_-1", "bdff5d65-29ef-425c-9096-a119e4de228f");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_CursedMolotov", "4f63b088-f686-4e09-8c0f-16df6504f0ea");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_CursedMolotov_-1", "4f63b088-f686-4e09-8c0f-16df6504f0ea");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_CursedPoisonFlask", "f216b8d2-4158-4ce6-b8c9-15e920a6add4");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_CursedPoisonFlask_-1", "f216b8d2-4158-4ce6-b8c9-15e920a6add4");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Flashbang", "a71888d9-9d3f-4004-96c3-bbc1a158c3f6");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Flashbang_-1", "a71888d9-9d3f-4004-96c3-bbc1a158c3f6");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Holy", "f7ecad76-b074-4164-a99f-9262d3cd66db");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Holy_-1", "f7ecad76-b074-4164-a99f-9262d3cd66db");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Ice", "a16947e3-5f2f-42c7-b05b-7cdaeb204d28");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Ice_-1", "a16947e3-5f2f-42c7-b05b-7cdaeb204d28");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Love", "22cd2247-45d7-432c-93bd-782777af3b33");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Love_-1", "22cd2247-45d7-432c-93bd-782777af3b33");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_MindMaggot", "2b8f5417-b1f4-4978-983b-a59dc67d903f");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_MindMaggot_-1", "2b8f5417-b1f4-4978-983b-a59dc67d903f");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Molotov", "5208b121-64fa-4704-8924-c61c576e1ac5");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Molotov_-1", "5208b121-64fa-4704-8924-c61c576e1ac5");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_MustardGas", "2cba3327-1650-4749-89ce-daeb6139aa17");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_MustardGas_-1", "2cba3327-1650-4749-89ce-daeb6139aa17");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Nailbomb", "c2dac4cd-724b-4179-b72b-84e0d9ffa7a1");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Nailbomb_-1", "c2dac4cd-724b-4179-b72b-84e0d9ffa7a1");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_OilFlask", "54b64fbb-86bf-4f8d-a5c3-a25eac3f8d9d");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_OilFlask_-1", "54b64fbb-86bf-4f8d-a5c3-a25eac3f8d9d");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_PoisonFlask", "6409a204-1ad0-4082-89b9-1edca837da2a");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_PoisonFlask_-1", "6409a204-1ad0-4082-89b9-1edca837da2a");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_SmokeBomb", "0c16cc46-26f9-4c07-b334-7905a10591ea");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_SmokeBomb_-1", "0c16cc46-26f9-4c07-b334-7905a10591ea");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Taser", "29373e1d-5f91-490e-89dd-747042a1d6c7");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Taser_-1", "29373e1d-5f91-490e-89dd-747042a1d6c7");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Terror", "cbdc1f53-1acf-4288-bdb2-3ab085d27f29");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Terror_-1", "cbdc1f53-1acf-4288-bdb2-3ab085d27f29");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Tremor", "220f7257-faa9-4bc4-903b-ae52765948ea");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_Tremor_-1", "220f7257-faa9-4bc4-903b-ae52765948ea");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_WaterBalloon", "ee4b83e0-b2dc-4880-a974-af7742e6e960");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_WaterBalloon_-1", "ee4b83e0-b2dc-4880-a974-af7742e6e960");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_WaterBlessedBalloon", "40ce7ae0-d0a9-4d76-b638-4bbd2814075f");
DB_OBHUN_GrenadeSkill("Projectile_Grenade_WaterBlessedBalloon_-1", "40ce7ae0-d0a9-4d76-b638-4bbd2814075f");
DB_OBHUN_GrenadeSkill("ProjectileStrike_Grenade_ClusterBomb", "f70ee2c6-9dda-4eed-b59b-75e4256c9059");
DB_OBHUN_GrenadeSkill("ProjectileStrike_Grenade_ClusterBomb_-1", "f70ee2c6-9dda-4eed-b59b-75e4256c9059");
DB_OBHUN_GrenadeSkill("ProjectileStrike_Grenade_CursedClusterBomb", "d9e9a62c-0266-440d-9501-a6c2c43a22f6");
DB_OBHUN_GrenadeSkill("ProjectileStrike_Grenade_CursedClusterBomb_-1", "d9e9a62c-0266-440d-9501-a6c2c43a22f6");
//END_REGION

//REGION Traps
//EA_STATUS, DAMAGESTATUS_TOAPPLY, VFX_TOPLAY, TRAPOVERLAY_TOAPPLY
DB_OBHUN_TrapType("ARROWHEAD_WATER", "OdinHUN_DMG_TRAP_WATER", "RS3_FX_Skills_Water_Ice_Shout_Ground_02", "OdinHUN_OVERLAY_TRAP_WATER");
DB_OBHUN_TrapType("ARROWHEAD_POISON", "OdinHUN_DMG_TRAP_POISON", "OdinHUN_TrapImpact_Poison", "OdinHUN_OVERLAY_TRAP_POISON");
DB_OBHUN_TrapType("ARROWHEAD_FIRE", "OdinHUN_DMG_TRAP_FIRE", "RS3_FX_Skills_Fire_Impact_03", "OdinHUN_OVERLAY_TRAP_FIRE");
DB_OBHUN_TrapType("ARROWHEAD_OIL", "OdinHUN_DMG_TRAP_EARTH", "OdinHUN_TrapImpact_Oil", "OdinHUN_OVERLAY_TRAP_OIL");
DB_OBHUN_TrapType("ARROWHEAD_BLOOD", "OdinHUN_DMG_TRAP_PHYSICAL", "", "");
DB_OBHUN_TrapType("ARROWHEAD_ELECTRIC", "OdinHUN_DMG_TRAP_AIR", "RS3_FX_Skills_Air_LightningBolt_Impact_01", "OdinHUN_OVERLAY_TRAP_AIR");
//END_REGION

KBSECTION
//REGION Apply Elemental Arrowheads damage
PROC
OBHUN_ApplyEAHit((INTEGER64)_HitHandle, (STRING)_PreDamageType, (STRING)_ConvertedDamageType, (INTEGER)_Damage)
AND
_PreDamageType != _ConvertedDamageType
AND
_PreDamageType != "Piercing"
THEN
NRD_HitClearAllDamage(_HitHandle);
// NRD_HitClearDamage(_HitHandle, _PreDamageType);
NRD_HitAddDamage(_HitHandle, _ConvertedDamageType, _Damage);

//Crit roll, used for status hits, e.g. Barrage bonus. TODO MIGHT BE UNUSED!
PROC
OBHUN_ApplyEAHit((INTEGER64)_HitHandle, (STRING)_PreDamageType, (STRING)_ConvertedDamageType, (INTEGER)_Damage, (INTEGER)_IsStatus, (GUIDSTRING)_Target, (GUIDSTRING)_Dealer)
AND
_IsStatus == 1
AND
_PreDamageType != "Piercing"
THEN
NRD_HitClearAllDamage(_HitHandle);
NRD_HitAddDamage(_HitHandle, _ConvertedDamageType, _Damage);
// NRD_HitExecute(_HitHandle);
//END_REGION

//REGION Excluded skill status flag
//When the player is using an EA-excluded skill, e.g. crafted arrows, set status for damage calculation
IF
CharacterUsedSkill(_Character, _Skill, _, _)
AND
DB_OBHUN_EA_ExcludedSkill(_Skill, _Timeout)
THEN
ApplyStatus(_Character, "OdinHUN_EA_EXCLUDEDSKILL", 6.0, 1, _Character);
CharacterStatusText(_Character, "Why is this not working");
ProcObjectTimer(_Character, "OdinHUN_EA_EXCLUDEDSKILL", _Timeout);

PROC
ProcObjectTimerFinished(_Character, "OdinHUN_EA_EXCLUDEDSKILL")
THEN
RemoveStatus(_Character, "OdinHUN_EA_EXCLUDEDSKILL");
CharacterStatusText((CHARACTERGUID)_Character, "Removie");

//IF the user is using EA, register the associated damage type
QRY
QRY_OBHUN_Determine_Type((GUIDSTRING)_Dealer, (STRING)_PreDamageType)
AND
DB_OBHUN_Elemental_Arrowhead_Users((CHARACTERGUID)_Dealer)
AND
DB_OBHUN_Elemental_Arrowhead((STRING)_Status, (STRING)_DamageType)
AND
_PreDamageType != _DamageType
AND
HasActiveStatus(_Dealer, _Status, 1)
THEN
DB_OBHUN_DeterminedType_Temp(_Dealer, _DamageType);
DB_NOOP(1);

// QRY
// QRY_OBHUN_Determine_Type((GUIDSTRING)_Dealer, (STRING)_PreDamageType)
// AND
// DB_OBHUN_Elemental_Arrowhead_Users((CHARACTERGUID)_Dealer)
// AND
// DB_OBHUN_Elemental_Arrowhead((STRING)_Status, (STRING)_DamageType)
// AND
// HasActiveStatus(_Dealer, _Status, 1)
// AND
// _PreDamageType != _DamageType
// THEN
// DB_OBHUN_DeterminedType_Temp(_Dealer, _DamageType);
// DB_NOOP(1);

//IF the user is not using EA, return the original damage type
QRY
QRY_OBHUN_Determine_Type((GUIDSTRING)_Dealer, (STRING)_PreDamageType)
AND
NOT DB_OBHUN_Elemental_Arrowhead_Users((CHARACTERGUID)_Dealer)
THEN
DB_OBHUN_DeterminedType_Temp(_Dealer, _PreDamageType);
DB_NOOP(1);
//END_REGION
EXITSECTION

ENDEXITSECTION
